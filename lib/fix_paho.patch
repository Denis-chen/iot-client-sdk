diff -Naur --strip-trailing-cr paho.mqtt.embedded-c-master/MQTTClient/src/MQTTClient.h paho.mqtt.embedded-c-master_patched/MQTTClient/src/MQTTClient.h
--- paho.mqtt.embedded-c-master/MQTTClient/src/MQTTClient.h	2016-09-12 21:15:18.000000000 +0300
+++ paho.mqtt.embedded-c-master_patched/MQTTClient/src/MQTTClient.h	2017-05-19 17:14:25.210572600 +0300
@@ -100,7 +100,7 @@
 
 public:
 
-    typedef void (*messageHandler)(MessageData&);
+    typedef FP<void, MessageData&> messageHandler;
 
     /** Construct the client
      *  @param network - pointer to an instance of the Network class - must be connected to the endpoint
@@ -109,12 +109,17 @@
      */
     Client(Network& network, unsigned int command_timeout_ms = 30000);
 
+    void setCommandTimeout(unsigned long command_timeout_ms)
+    {
+        this->command_timeout_ms = command_timeout_ms;
+    }
+
     /** Set the default message handling callback - used for any message which does not match a subscription message handler
      *  @param mh - pointer to the callback function
      */
     void setDefaultMessageHandler(messageHandler mh)
     {
-        defaultMessageHandler.attach(mh);
+        defaultMessageHandler = mh;
     }
 
     /** MQTT Connect - send an MQTT connect packet down the network and wait for a Connack
@@ -131,6 +136,8 @@
      */
     int connect(MQTTPacket_connectData& options);
 
+    int connect(MQTTPacket_connectData& options, bool& sessionPresent);
+
     /** MQTT Publish - send an MQTT publish packet and wait for all acks to complete for all QoSs
      *  @param topic - the topic to publish to
      *  @param message - the message to send
@@ -224,10 +231,10 @@
     struct MessageHandlers
     {
         const char* topicFilter;
-        FP<void, MessageData&> fp;
+        messageHandler fp;
     } messageHandlers[MAX_MESSAGE_HANDLERS];      // Message handlers are indexed by subscription topic
 
-    FP<void, MessageData&> defaultMessageHandler;
+    messageHandler defaultMessageHandler;
 
     bool isconnected;
 
@@ -658,7 +665,7 @@
 
 
 template<class Network, class Timer, int MAX_MQTT_PACKET_SIZE, int b>
-int MQTT::Client<Network, Timer, MAX_MQTT_PACKET_SIZE, b>::connect(MQTTPacket_connectData& options)
+int MQTT::Client<Network, Timer, MAX_MQTT_PACKET_SIZE, b>::connect(MQTTPacket_connectData& options, bool& sessionPresent)
 {
     Timer connect_timer(command_timeout_ms);
     int rc = FAILURE;
@@ -680,7 +687,7 @@
     if (waitfor(CONNACK, connect_timer) == CONNACK)
     {
         unsigned char connack_rc = 255;
-        bool sessionPresent = false;
+        sessionPresent = false;
         if (MQTTDeserialize_connack((unsigned char*)&sessionPresent, &connack_rc, readbuf, MAX_MQTT_PACKET_SIZE) == 1)
             rc = connack_rc;
         else
@@ -716,6 +723,14 @@
 
 
 template<class Network, class Timer, int MAX_MQTT_PACKET_SIZE, int b>
+int MQTT::Client<Network, Timer, MAX_MQTT_PACKET_SIZE, b>::connect(MQTTPacket_connectData& options)
+{
+    bool sessionPresent;
+    return connect(options, sessionPresent);
+}
+
+
+template<class Network, class Timer, int MAX_MQTT_PACKET_SIZE, int b>
 int MQTT::Client<Network, Timer, MAX_MQTT_PACKET_SIZE, b>::connect()
 {
     MQTTPacket_connectData default_options = MQTTPacket_connectData_initializer;
@@ -748,12 +763,17 @@
             rc = grantedQoS; // 0, 1, 2 or 0x80
         if (rc != 0x80)
         {
+            if (MAX_MESSAGE_HANDLERS <= 0)
+            {
+                rc = 0;
+            }
+
             for (int i = 0; i < MAX_MESSAGE_HANDLERS; ++i)
             {
                 if (messageHandlers[i].topicFilter == 0)
                 {
                     messageHandlers[i].topicFilter = topicFilter;
-                    messageHandlers[i].fp.attach(messageHandler);
+                    messageHandlers[i].fp = messageHandler;
                     rc = 0;
                     break;
                 }
@@ -928,10 +948,16 @@
     if (len > 0)
         rc = sendPacket(len, timer);            // send the disconnect packet
 
-	if (cleansession)
-		cleanSession();
-	else
-	    isconnected = false;
+    if (cleansession)
+    {
+        cleanSession();
+    }
+    else
+    {
+        isconnected = false;
+        ping_outstanding = false;
+    }
+
     return rc;
 }
 
diff -Naur --strip-trailing-cr paho.mqtt.embedded-c-master/MQTTPacket/src/MQTTFormat.c paho.mqtt.embedded-c-master_patched/MQTTPacket/src/MQTTFormat.c
--- paho.mqtt.embedded-c-master/MQTTPacket/src/MQTTFormat.c	2016-09-12 21:15:18.000000000 +0300
+++ paho.mqtt.embedded-c-master_patched/MQTTPacket/src/MQTTFormat.c	2017-05-16 17:09:38.310817600 +0300
@@ -196,7 +196,7 @@
 	{
 	case CONNECT:
 	{
-		MQTTPacket_connectData data;
+		MQTTPacket_connectData data = MQTTPacket_connectData_initializer;
 		int rc;
 		if ((rc = MQTTDeserialize_connect(&data, buf, buflen)) == 1)
 			strindex = MQTTStringFormat_connect(strbuf, strbuflen, &data);
